<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Workflows Input &amp; Output · Cumulus Documentation</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="# Ingest Inputs and Return Values"/><meta name="docsearch:version" content="1.15.0"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Workflows Input &amp; Output · Cumulus Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://nasa.github.io/cumulus/"/><meta property="og:description" content="# Ingest Inputs and Return Values"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/cumulus/undefined"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/cumulus/js/scrollSpy.js"></script><link rel="stylesheet" href="/cumulus/css/main.css"/><script src="/cumulus/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/cumulus/"><h2 class="headerTitle">Cumulus Documentation</h2></a><a href="/cumulus/versions"><h3>1.15.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://nasa.github.io/cumulus-api" target="_self">API Docs</a></li><li class="siteNavGroupActive"><a href="/cumulus/docs/1.15.0/cumulus-docs-readme" target="_self">Developer Docs</a></li><li class=""><a href="/cumulus/docs/1.15.0/data-cookbooks/about-cookbooks" target="_self">Data-Cookbooks</a></li><li class=""><a href="/cumulus/docs/1.15.0/operator-docs/about-operator-docs" target="_self">Operator Docs</a></li><li class="siteNavGroupActive"><a href="/cumulus/docs/1.15.0/team" target="_self">Team</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>What are Cumulus Workflows?</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">About Cumulus<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/cumulus-docs-readme">Cumulus Description</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/architecture">Cumulus Architecture</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/interfaces">Cumulus Interfaces</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/glossary">Cumulus Glossary</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/team">Team</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">What are Cumulus Workflows?<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/workflows/workflows-readme">Workflows</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/workflows/protocol">Workflow Protocol</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/cumulus/docs/1.15.0/workflows/input_output">Workflows Input &amp; Output</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/workflows/cumulus-task-message-flow">Cumulus Tasks: Message Flow</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/workflows/developing-workflow-tasks">Developing Workflow Tasks</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/workflows/lambda">Develop Lambda Functions</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/workflows/docker">Dockerizing Data Processing</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/workflows/workflow-configuration-how-to">Workflow Configuration How To&#x27;s</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/workflows/workflow-triggers">Workflow Triggers</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Tasks<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/tasks">Cumulus Tasks</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/workflow_tasks/discover_granules">Discover Granules</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/workflow_tasks/files_to_granules">Files To Granules</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/workflow_tasks/move_granules">Move Granules</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/workflow_tasks/parse_pdr">Parse PDR</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Deployment<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/deployment/deployment-readme">How to Deploy Cumulus</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/deployment/components">Cumulus Components</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/deployment/create_bucket">Creating an S3 Bucket</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/deployment/server_access_logging">S3 Server Access Logging</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/deployment/iam_roles">Cumulus IAM Roles</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/deployment/obtain_cumulus_packages">Obtaining Cumulus Packages</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/deployment/config_descriptions">Configuration Descriptions</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/deployment/cmr_launchpad_authentication">CMR Launchpad Authentication</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/deployment/cumulus_api_launchpad_authentication">Cumulus API Launchpad Authentication</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/deployment/troubleshoot_deployment">Troubleshooting Cumulus Deployment</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/deployment/distribution_component">Cumulus Distribution Terraform Module</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/deployment/thin_egress_app">Thin Egress App</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Deployment Options<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/additional-deployment-options/delete-api-gateway-stages">Delete API Gateway Stages</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/additional-deployment-options/enable-gateway-logging-permissions">API Gateway Logging Permissions</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/additional-deployment-options/enable-api-logs">Enable API Gateway Logging</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/additional-deployment-options/configure-cloudwatch-logs-delivery">API Gateway Logs Delivery</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/additional-deployment-options/additional-lambda-logging">Lambda Log Subscriptions</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/additional-deployment-options/share-s3-access-logs">Share S3 Access Logs</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Additional Features<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/features/dead_letter_queues">Dead Letter Queues</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/features/ems_reporting">EMS Reporting</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/features/execution_payload_retention">Execution Payload Retention</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/features/lambda_versioning">Lambda Versioning</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/features/ancillary_metadata">Ancillary Metadata Export</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/features/distribution-metrics">Cumulus Distribution Metrics</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Upgrading Cumulus<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/upgrade/upgrade-readme">Upgrading Cumulus</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Troubleshooting<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/system-documentation/system-documentation">Troubleshooting Cumulus</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Cumulus Development<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/adding-a-task">Contributing a Task</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/1.15.0/docs-how-to">Cumulus Documentation: How To&#x27;s</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="ingest-inputs-and-return-values"></a><a href="#ingest-inputs-and-return-values" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ingest Inputs and Return Values</h1>
<h2><a class="anchor" aria-hidden="true" id="general-structure"></a><a href="#general-structure" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>General Structure</h2>
<p>Cumulus uses a common format for all inputs and outputs to workflows. The same format is used for input and output from workflow steps. The common format consists of a JSON object which holds all necessary information about the task execution and AWS environment. Tasks return objects identical in format to their input with the exception of a task-specific <code>payload</code> field. Tasks may also augment their execution metadata.</p>
<h2><a class="anchor" aria-hidden="true" id="cumulus-message-adapter"></a><a href="#cumulus-message-adapter" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cumulus Message Adapter</h2>
<p>The Cumulus Message Adapter and Cumulus Message Adapter libraries help task developers integrate their tasks into a Cumulus workflow. These libraries adapt input and outputs from tasks into the Cumulus Message format. The Scheduler service creates the initial event message by combining the collection configuration, external resource configuration, workflow configuration, and deployment environment settings.  The subsequent workflow messages between tasks must conform to the message schema. By using the Cumulus Message Adapter, individual task Lambda functions only receive the input and output specifically configured for the task, and not non-task-related message fields.</p>
<p>The Cumulus Message Adapter libraries are called by the tasks with a callback function containing the business logic of the task as a parameter. They first adapt the incoming message to a format more easily consumable by Cumulus tasks, then invoke the task, and then adapt the task response back to the Cumulus message protocol to be sent to the next task.</p>
<p>A task's Lambda function can be configured to include a Cumulus Message Adapter library which constructs input/output messages and resolves task configurations.     The CMA can then be included in one of three ways:</p>
<h4><a class="anchor" aria-hidden="true" id="kes-injection"></a><a href="#kes-injection" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kes Injection</h4>
<p>In the Lambda function configuration file lambdas.yml, a task Lambda function can be configured to include the latest CMA via kes.  Kes will download and include the latest CMA package in the Lambda that's uploaded to AWS:</p>
<pre><code class="hljs css language-yaml">    <span class="hljs-attr">DiscoverPdrs:</span>
      <span class="hljs-attr">handler:</span> <span class="hljs-string">index.handler</span>
      <span class="hljs-attr">useMessageAdapter:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>Optionally you can configure kes to specify the version of the CMA to be used using the <code>message_adapter_version</code> configuration key:</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">message_adapter_version:</span> <span class="hljs-string">v1.0.13</span>
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="lambda-layer"></a><a href="#lambda-layer" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lambda Layer</h4>
<p>In order to make use of this configuration, a Lambda layer can be uploaded to your account.  Due to platform restrictions, Core cannot currently support sharable public layers, however you can support deploying the appropriate version from <a href="https://github.com/nasa/cumulus-message-adapter/releases">the release page</a> via the AWS <a href="https://console.aws.amazon.com/lambda/home?region=us-east-1#/layers">Layers Interface</a>, <em>or</em> the provided CMA <a href="https://www.terraform.io/">Terraform</a> module located at <a href="https://github.com/nasa/cumulus/tree/master/tf-modules/cumulus-message-adapter">tf-modules/cumulus-message-adapter</a>.</p>
<p>Once you've deployed the layer, include the CMA in the configured Lambda layers:</p>
<pre><code class="hljs css language-yaml">    <span class="hljs-attr">DiscoverPdrs:</span>
      <span class="hljs-attr">layers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">arn:aws:lambda:us-east-1:{{AWS_ACCOUNT_ID}}:layer:Cumulus_Message_Adapter:{version</span> <span class="hljs-string">number}</span>
</code></pre>
<p>In the future if you wish to update/change the CMA version you will need to update the deployed CMA, and update the layer configuration for the impacted Lambdas as needed, or re-run the Terraform module.     If you have a large number of Lambdas utilizing the CMA, you can include a configuration key in your <code>config.yml</code>:</p>
<pre><code class="hljs css language-yaml">    <span class="hljs-attr">cma_layer:</span> <span class="hljs-string">arn:aws:lambda:us-east-1:{{AWS_ACCOUNT_ID}}:layer:Cumulus_Message_Adapter:{version</span> <span class="hljs-string">number}</span>
</code></pre>
<p>and include the reference in the Lambda configuration:</p>
<pre><code class="hljs css language-yaml">    <span class="hljs-attr">DiscoverPdrs:</span>
      <span class="hljs-attr">layers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">'<span class="hljs-template-variable">{{cma_layer}'
</span></span></code></pre>
<p><strong><em>Please Note</em></strong>: Updating/removing a layer does not change a deployed Lambda, so to update the CMA you should deploy a new version of the CMA layer, update the associated Lambda configuration to reference the new CMA version, and re-deploy your Lambdas.</p>
<p><strong><em>Please Note</em></strong>: Updating the CMA without updating the lambda code will fail if operating with the Workflow Lambda Versions feature enabled.  If you are utilizing this option, we recommend continuing use of kes injection/manual addition for now.</p>
<p>This method will be supported more fully once migration to Terraform Deployments has been completed.</p>
<h4><a class="anchor" aria-hidden="true" id="manual-addition"></a><a href="#manual-addition" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Manual Addition</h4>
<p>You can include the CMA package in the Lambda code in the <code>cumulus-message-adapter</code> sub-directory, this will achieve a similar result to kes injection, but will require manual updates to update the CMA code.</p>
<p>Cumulus will set a default <code>CUMULUS_MESSAGE_ADAPTER_DIR</code> environment variable to the <code>cmaDir</code> global configuration value, which defaults to <code>/opt/</code>.   If <code>useMessageAdapter: true</code> is set, it will set it to the <code>cumulus-message-adapter</code> directory.</p>
<p>If you are manually adding the message adapter to your source and utilizing the CMA, you should set the Lambda's <code>CUMULUS_MESSAGE_ADAPTER_DIR</code> environment variable to override this, or if you aren't utilizing the CMA layer, set the global <code>cmaDir</code> to the directory you're packaging your Lambda in.</p>
<h3><a class="anchor" aria-hidden="true" id="cma-inputoutput"></a><a href="#cma-inputoutput" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CMA Input/Output</h3>
<p>Input to the task application code is a json object with keys:</p>
<ul>
<li><code>input</code>: By default, the incoming payload is the payload output from the previous task, or it can be a portion of the payload as configured for the task in the corresponding <code>.yml</code> file in the <code>workflows</code> directory.</li>
<li><code>config</code>: Task-specific configuration object with URL templates resolved.</li>
</ul>
<p>Output from the task application code is returned in and placed in the <code>payload</code> key by default, but the <code>config</code> key can also be used to return just a portion of the task output.</p>
<h3><a class="anchor" aria-hidden="true" id="cma-configuration"></a><a href="#cma-configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CMA configuration</h3>
<p>As of Cumulus &gt; 1.15 and CMA &gt; v1.1.1, configuration of the CMA is expected to be driven by AWS Step Function Parameters.</p>
<p>Using the CMA package with the lambda by by any of the above mentioned methods (Manual, Kes, Lambda Layers) requires configuration for it's various features via a specific Step Function Parameters configuration format:</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">StepFunction:</span>
  <span class="hljs-attr">Parameters:</span>
    <span class="hljs-attr">cma:</span>
      <span class="hljs-string">event.$:</span> <span class="hljs-string">'$'</span>
      <span class="hljs-attr">configuration keys:</span> <span class="hljs-string">...</span>
</code></pre>
<p>The <code>event.$: '$'</code> parameter is <em>required</em> as it passes the entire incoming message to the CMA client library for parsing, and the CMA itself to convert the incoming message into a Cumulus message for use in the function.</p>
<p>The following are the CMA's current configuration settings:</p>
<h4><a class="anchor" aria-hidden="true" id="replaceconfig-cumulus-remote-message"></a><a href="#replaceconfig-cumulus-remote-message" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ReplaceConfig (Cumulus Remote Message)</h4>
<p>Because of the potential size of a Cumulus message, mainly the <code>payload</code> field, a task can be set via configuration to store a portion of its output on S3 with a message key <code>Remote Message</code> that defines how to retrieve it and an empty JSON object <code>{}</code> in its place.   If the portion of the message targeted exceeds the configured <code>MaxSize</code> (defaults to 0 bytes) it will be written to S3.</p>
<p>The CMA remote message functionality can be configured using parameters in several ways:</p>
<h5><a class="anchor" aria-hidden="true" id="partial-message"></a><a href="#partial-message" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Partial Message</h5>
<p>Setting the <code>Path</code>/<code>Target</code> path in the <code>ReplaceConfig</code> parameter (and optionally a non-default <code>MaxSize</code>)</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">DiscoverGranules:</span>
  <span class="hljs-attr">Parameters:</span>
    <span class="hljs-attr">cma:</span>
      <span class="hljs-string">event.$:</span> <span class="hljs-string">'$'</span>
      <span class="hljs-attr">ReplaceConfig:</span>
        <span class="hljs-attr">MaxSize:</span> <span class="hljs-number">1</span>
        <span class="hljs-attr">Path:</span> <span class="hljs-string">'$.payload'</span>
        <span class="hljs-attr">TargetPath:</span> <span class="hljs-string">'$.payload'</span>
</code></pre>
<p>will result in any <code>payload</code> output larger than the <code>MaxSize</code> (in bytes) to be written to S3.  The CMA will then mark that the key has been replaced via a <code>replace</code> key on the event. When the CMA picks up the <code>replace</code> key in future steps, it will attempt to retrieve the output from S3 and write it back to <code>payload</code>.</p>
<p>Note that you can optionally use a different <code>TargetPath</code> than <code>Path</code>, however as the target is a JSON path there must be a key to target for replacement in the output of that step.    Also note that the JSON path specified must target <em>one</em> node, otherwise the CMA will error, as it does not support multiple replacement targets.</p>
<p>If <code>TargetPath</code> is omitted, it will default to the value for <code>Path</code>.</p>
<h5><a class="anchor" aria-hidden="true" id="full-message"></a><a href="#full-message" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Full Message</h5>
<p>Setting the following parameters for a lambda:</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">DiscoverGranules:</span>
  <span class="hljs-attr">Parameters:</span>
    <span class="hljs-attr">cma:</span>
      <span class="hljs-string">event.$:</span> <span class="hljs-string">'$'</span>
      <span class="hljs-attr">ReplaceConfig:</span>
        <span class="hljs-attr">FullMessage:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>will result in the CMA assuming the entire inbound message should be stored to S3 if it exceeds the default max size.</p>
<p>This is effectively the same as doing:</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">DiscoverGranules:</span>
  <span class="hljs-attr">Parameters:</span>
    <span class="hljs-attr">cma:</span>
      <span class="hljs-string">event.$:</span> <span class="hljs-string">'$'</span>
      <span class="hljs-attr">ReplaceConfig:</span>
        <span class="hljs-attr">MaxSize:</span> <span class="hljs-number">0</span>
        <span class="hljs-attr">Path:</span> <span class="hljs-string">'$'</span>
        <span class="hljs-attr">TargetPath:</span> <span class="hljs-string">'$'</span>
</code></pre>
<h5><a class="anchor" aria-hidden="true" id="cumulus-message-example"></a><a href="#cumulus-message-example" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cumulus Message example:</h5>
<pre><code class="hljs css language-json">{
  <span class="hljs-attr">"task_config"</span>: {
    <span class="hljs-attr">"inlinestr"</span>: <span class="hljs-string">"prefix{meta.foo}suffix"</span>,
    <span class="hljs-attr">"array"</span>: <span class="hljs-string">"{[$.meta.foo]}"</span>,
    <span class="hljs-attr">"object"</span>: <span class="hljs-string">"{$.meta}"</span>
  },
  <span class="hljs-attr">"cumulus_meta"</span>: {
    <span class="hljs-attr">"message_source"</span>: <span class="hljs-string">"sfn"</span>,
    <span class="hljs-attr">"state_machine"</span>: <span class="hljs-string">"arn:aws:states:us-east-1:1234:stateMachine:MySfn"</span>,
    <span class="hljs-attr">"execution_name"</span>: <span class="hljs-string">"MyExecution__id-1234"</span>,
    <span class="hljs-attr">"id"</span>: <span class="hljs-string">"id-1234"</span>
  },
  <span class="hljs-attr">"meta"</span>: {
    <span class="hljs-attr">"foo"</span>: <span class="hljs-string">"bar"</span>
  },
  <span class="hljs-attr">"payload"</span>: {
    <span class="hljs-attr">"anykey"</span>: <span class="hljs-string">"anyvalue"</span>
  }
}
</code></pre>
<h5><a class="anchor" aria-hidden="true" id="cumulus-remote-message-example"></a><a href="#cumulus-remote-message-example" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cumulus Remote Message example:</h5>
<p>The message may contain a reference to an S3 Bucket, Key and TargetPath as follows:</p>
<pre><code class="hljs css language-json">{
  <span class="hljs-attr">"replace"</span>: {
    <span class="hljs-attr">"Bucket"</span>: <span class="hljs-string">"cumulus-bucket"</span>,
    <span class="hljs-attr">"Key"</span>: <span class="hljs-string">"my-large-event.json"</span>,
    <span class="hljs-attr">"TargetPath"</span>: <span class="hljs-string">"$"</span>
  },
  <span class="hljs-attr">"cumulus_meta"</span>: {}
}
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="task_config"></a><a href="#task_config" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>task_config</h4>
<p>This configuration key contains the input/output configuration values for definition of inputs/outputs via URL paths.
<strong>Important</strong>:  These values are all relative to json object configured for <code>event.$</code>.</p>
<p>This configuration's behavior is outlined in the CMA step description (Cumulus Message Adapter has the following steps) below.</p>
<p>The configuration should follow the format:</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">FunctionName:</span>
  <span class="hljs-attr">Parameters:</span>
    <span class="hljs-attr">cma:</span>
      <span class="hljs-string">event.$:</span> <span class="hljs-string">'$'</span>
      <span class="hljs-attr">other_cma_configuration:</span> <span class="hljs-string">'&lt;config object&gt;'</span>
      <span class="hljs-attr">task_config:</span> <span class="hljs-string">'&lt;task config&gt;'</span>

</code></pre>
<p>Example:</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">StepFunction:</span>
  <span class="hljs-attr">Parameters:</span>
    <span class="hljs-attr">cma:</span>
      <span class="hljs-string">event.$:</span> <span class="hljs-string">'$'</span>
      <span class="hljs-attr">task_config:</span>
        <span class="hljs-attr">sfnEnd:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">stack:</span> <span class="hljs-string">'{$.meta.stack}'</span>
        <span class="hljs-attr">bucket:</span> <span class="hljs-string">'{$.meta.buckets.internal.name}'</span>
        <span class="hljs-attr">stateMachine:</span> <span class="hljs-string">'{$.cumulus_meta.state_machine}'</span>
        <span class="hljs-attr">executionName:</span> <span class="hljs-string">'{$.cumulus_meta.execution_name}'</span>
        <span class="hljs-attr">cumulus_message:</span>
          <span class="hljs-attr">input:</span> <span class="hljs-string">'{$}'</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="cumulus-message-adapter-has-the-following-steps"></a><a href="#cumulus-message-adapter-has-the-following-steps" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cumulus Message Adapter has the following steps:</h3>
<h4><a class="anchor" aria-hidden="true" id="1-reformat-aws-step-function-message-into-cumulus-message"></a><a href="#1-reformat-aws-step-function-message-into-cumulus-message" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. Reformat AWS Step Function message into Cumulus Message</h4>
<p>Due to the way AWS handles Parmeterized messages, when Parameters are used the CMA takes an inbound message:</p>
<pre><code class="hljs css language-json">{
  <span class="hljs-attr">"resource"</span>: <span class="hljs-string">"arn:aws:lambda:us-east-1:&lt;lambda arn values&gt;"</span>,
  <span class="hljs-attr">"input"</span>: {
    <span class="hljs-attr">"Other Parameter"</span>: {},
    <span class="hljs-attr">"cma"</span>: {
      <span class="hljs-attr">"ConfigKey"</span>: {
        <span class="hljs-attr">"config values"</span>: <span class="hljs-string">"some config values"</span>
      },
      <span class="hljs-attr">"event"</span>: {
        <span class="hljs-attr">"cumulus_meta"</span>: {},
        <span class="hljs-attr">"payload"</span>: {},
        <span class="hljs-attr">"meta"</span>: {},
        <span class="hljs-attr">"exception"</span>: {}
      }
    }
  }
}
</code></pre>
<p>and takes the following actions:</p>
<ul>
<li>Takes the object at <code>input.cma.event</code> and makes it the full input</li>
<li>Merges all of the keys except <code>event</code> under <code>input.cma</code> into the parent input object</li>
</ul>
<p>This results in the incoming message (presumably a Cumulus message) with any cma configuration parameters merged in being passed to the CMA.    <em>All other parameterized values defined outside of the <code>cma</code> key are ignored</em></p>
<h4><a class="anchor" aria-hidden="true" id="2-resolve-remote-messages"></a><a href="#2-resolve-remote-messages" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. Resolve Remote Messages</h4>
<p>If the incoming Cumulus message has a <code>replace</code> key value, the CMA will attempt to pull the payload from S3,</p>
<p>For example, if the incoming contains the following:</p>
<pre><code class="hljs css language-json">  "meta": {
    "foo": {}
  },
  "replace": {
    "TargetPath": "$.meta.foo",
    "Bucket": "some_bucket",
    "Key": "events/some-event-id"
  }
</code></pre>
<p>The CMA will attempt to pull the file stored at <code>Bucket</code>/<code>Key</code> and replace the value at <code>TargetPath</code>, then remove the <code>replace</code> object entirely and continue.</p>
<h4><a class="anchor" aria-hidden="true" id="3-resolve-url-templates-in-the-task-configuration"></a><a href="#3-resolve-url-templates-in-the-task-configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3. Resolve URL templates in the task configuration</h4>
<p>In the workflow configuration (defined under the <code>task_config</code> key), each task has its own configuration, and it can use URL template as a value to achieve simplicity or for values only available at execution time. The Cumulus Message Adapter resolves the URL templates (relative to the event configuration key) and then passes message to next task. For example, given a task which has the following configuration:</p>
<pre><code class="hljs css language-yaml">    <span class="hljs-attr">Discovery:</span>
      <span class="hljs-attr">Parameters:</span>
        <span class="hljs-attr">cma:</span>
          <span class="hljs-string">event.$:</span> <span class="hljs-string">'$'</span>
          <span class="hljs-attr">task_config:</span>
            <span class="hljs-attr">provider:</span> <span class="hljs-string">'{$.meta.provider}'</span>
              <span class="hljs-attr">inlinestr:</span> <span class="hljs-string">'prefix{meta.foo}suffix'</span>
              <span class="hljs-attr">array:</span> <span class="hljs-string">'{[$.meta.foo]}'</span>
              <span class="hljs-attr">object:</span> <span class="hljs-string">'{$.meta}'</span>
</code></pre>
<p><em>and</em> and incoming message that contains:</p>
<pre><code class="hljs css language-json">      "meta": {
        "foo": "bar",
        "provider": {
          "id": "FOO_DAAC",
          "anykey": "anyvalue"
        }
      }
</code></pre>
<p>The corresponding Cumulus Message would contain:</p>
<pre><code class="hljs css language-yaml">    <span class="hljs-string">{</span>
      <span class="hljs-attr">"meta":</span> <span class="hljs-string">{</span>
        <span class="hljs-attr">"foo":</span> <span class="hljs-string">"bar"</span><span class="hljs-string">,</span>
        <span class="hljs-attr">"provider":</span> <span class="hljs-string">{</span>
          <span class="hljs-attr">"id":</span> <span class="hljs-string">"FOO_DAAC"</span><span class="hljs-string">,</span>
          <span class="hljs-attr">"anykey":</span> <span class="hljs-string">"anyvalue"</span>
        <span class="hljs-string">},</span>
        <span class="hljs-string">...</span>
      <span class="hljs-string">},</span>
      <span class="hljs-attr">"task_config":</span> <span class="hljs-string">{</span>
        <span class="hljs-string">"provider: "</span><span class="hljs-string">{$.meta.provider}",</span>
        <span class="hljs-attr">"inlinestr":</span> <span class="hljs-string">"prefix{meta.foo}suffix"</span><span class="hljs-string">,</span>
        <span class="hljs-attr">"array":</span> <span class="hljs-string">"{[$.meta.foo]}"</span><span class="hljs-string">,</span>
        <span class="hljs-attr">"object":</span> <span class="hljs-string">"{$.meta}"</span>
        <span class="hljs-string">...</span>
      <span class="hljs-string">}</span>
    <span class="hljs-string">}</span>
</code></pre>
<p>The message sent to the task would be:</p>
<pre><code class="hljs css language-yaml">    <span class="hljs-string">{</span>
      <span class="hljs-string">"config"</span> <span class="hljs-string">:</span> <span class="hljs-string">{</span>
        <span class="hljs-string">"provider: {
          "</span><span class="hljs-string">id":</span> <span class="hljs-string">"FOO_DAAC"</span><span class="hljs-string">,</span>
          <span class="hljs-attr">"anykey":</span> <span class="hljs-string">"anyvalue"</span>
        <span class="hljs-string">},</span>
        <span class="hljs-attr">"inlinestr":</span> <span class="hljs-string">"prefixbarsuffix"</span><span class="hljs-string">,</span>
        <span class="hljs-attr">"array":</span> <span class="hljs-string">["bar"]</span>
        <span class="hljs-attr">"object":</span> <span class="hljs-string">{</span>
          <span class="hljs-attr">"foo":</span> <span class="hljs-string">"bar"</span><span class="hljs-string">,</span>
          <span class="hljs-attr">"provider":</span> <span class="hljs-string">{</span>
            <span class="hljs-attr">"id":</span> <span class="hljs-string">"FOO_DAAC"</span><span class="hljs-string">,</span>
            <span class="hljs-attr">"anykey":</span> <span class="hljs-string">"anyvalue"</span>
           <span class="hljs-string">},</span>
           <span class="hljs-string">...</span>
        <span class="hljs-string">},</span>
      <span class="hljs-string">},</span>
      <span class="hljs-string">"input"</span><span class="hljs-string">:{...}</span>
    <span class="hljs-string">}</span>
</code></pre>
<p>URL template variables replace dotted paths inside curly brackets with their corresponding value. If the Cumulus Message Adapter cannot resolve a value, it will ignore the template, leaving it verbatim in the string.  While seemingly complex, this allows significant decoupling of Tasks from one another and the data that drives them. Tasks are able to easily receive runtime configuration produced by previously run tasks and domain data.</p>
<h4><a class="anchor" aria-hidden="true" id="4-resolve-task-input"></a><a href="#4-resolve-task-input" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4. Resolve task input</h4>
<p>By default, the incoming payload is the payload from the previous task.  The task can also be configured to use a portion of the payload its input message.  For example, given a task specifies <code>cma.task_config.cumulus_message.input</code>:</p>
<pre><code class="hljs css language-yaml">    <span class="hljs-attr">ExampleTask:</span>
      <span class="hljs-attr">Parameters:</span>
        <span class="hljs-attr">cma:</span>
          <span class="hljs-string">event.$:</span> <span class="hljs-string">'$'</span>
          <span class="hljs-attr">task_config:</span>
            <span class="hljs-attr">cumulus_message:</span>
                <span class="hljs-attr">input:</span> <span class="hljs-string">'{$.payload.foo}'</span>
</code></pre>
<p>The task configuration in the message would be:</p>
<pre><code class="hljs css language-json">    {
      <span class="hljs-attr">"task_config"</span>: {
        <span class="hljs-attr">"cumulus_message"</span>: {
          <span class="hljs-attr">"input"</span>: <span class="hljs-string">"{$.payload.foo}"</span>
        }
      },
      <span class="hljs-attr">"payload"</span>: {
        <span class="hljs-attr">"foo"</span>: {
          <span class="hljs-attr">"anykey"</span>: <span class="hljs-string">"anyvalue"</span>
        }
      }
    }
</code></pre>
<p>The Cumulus Message Adapter will resolve the task input, instead of sending the whole <code>payload</code> as task input, the task input would be:</p>
<pre><code class="hljs css language-yaml">    <span class="hljs-string">{</span>
      <span class="hljs-string">"input"</span> <span class="hljs-string">:</span> <span class="hljs-string">{</span>
        <span class="hljs-attr">"anykey":</span> <span class="hljs-string">"anyvalue"</span>
      <span class="hljs-string">},</span>
      <span class="hljs-attr">"config":</span> <span class="hljs-string">{...}</span>
    <span class="hljs-string">}</span>
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="5-resolve-task-output"></a><a href="#5-resolve-task-output" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5. Resolve task output</h4>
<p>By default, the task's return value is the next payload.  However, the workflow task configuration can specify a portion of the return value as the next payload, and can also augment values to other fields. Based on the task configuration under <code>cma.task_config.cumulus_message.outputs</code>, the Message Adapter uses a task's return value to output a message as configured by the task-specific config defined under <code>cma.task_config</code>. The Message Adapter dispatches a &quot;source&quot; to a &quot;destination&quot; as defined by URL templates stored in the task-specific <code>cumulus_message.outputs</code>. The value of the task's return value at the &quot;source&quot; URL is used to create or replace the value of the task's return value at the &quot;destination&quot; URL. For example, given a task specifies cumulus_message.output in its workflow configuration as follows:</p>
<pre><code class="hljs css language-yaml">    <span class="hljs-attr">ExampleTask:</span>
      <span class="hljs-attr">Parameters:</span>
        <span class="hljs-attr">cma:</span>
          <span class="hljs-string">event.$:</span> <span class="hljs-string">'$'</span>
          <span class="hljs-attr">task_config:</span>
            <span class="hljs-attr">cumulus_message:</span>
                <span class="hljs-attr">outputs:</span>
                  <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">'{$}'</span>
                    <span class="hljs-attr">destination:</span> <span class="hljs-string">'{$.payload}'</span>
                  <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">'{$.output.anykey}'</span>
                    <span class="hljs-attr">destination:</span> <span class="hljs-string">'{$.meta.baz}'</span>
</code></pre>
<p>The corresponding Cumulus Message would be:</p>
<pre><code class="hljs css language-json">    {
      <span class="hljs-attr">"task_config"</span>: {
        <span class="hljs-attr">"cumulus_message"</span>: {
          <span class="hljs-attr">"outputs"</span>: [
            {
              <span class="hljs-attr">"source"</span>: <span class="hljs-string">"{$}"</span>,
              <span class="hljs-attr">"destination"</span>: <span class="hljs-string">"{$.payload}"</span>
            },
            {
              <span class="hljs-attr">"source"</span>: <span class="hljs-string">"{$.output.anykey}"</span>,
              <span class="hljs-attr">"destination"</span>: <span class="hljs-string">"{$.meta.baz}"</span>
            }
          ]
        }
      },
      <span class="hljs-attr">"meta"</span>: {
        <span class="hljs-attr">"foo"</span>: <span class="hljs-string">"bar"</span>
      },
      <span class="hljs-attr">"payload"</span>: {
        <span class="hljs-attr">"anykey"</span>: <span class="hljs-string">"anyvalue"</span>
      }
    }
</code></pre>
<p>Given the response from the task is:</p>
<pre><code class="hljs css language-json">    {
      <span class="hljs-attr">"output"</span>: {
          <span class="hljs-attr">"anykey"</span>: <span class="hljs-string">"boo"</span>
      }
    }
</code></pre>
<p>The Cumulus Message Adapter would output the following Cumulus Message:</p>
<pre><code class="hljs css language-json">    {
      <span class="hljs-attr">"task_config"</span>: {
          <span class="hljs-attr">"cumulus_message"</span>: {
            <span class="hljs-attr">"outputs"</span>: [
              {
                <span class="hljs-attr">"source"</span>: <span class="hljs-string">"{$}"</span>,
                <span class="hljs-attr">"destination"</span>: <span class="hljs-string">"{$.payload}"</span>
              },
              {
                <span class="hljs-attr">"source"</span>: <span class="hljs-string">"{$.output.anykey}"</span>,
                <span class="hljs-attr">"destination"</span>: <span class="hljs-string">"{$.meta.baz}"</span>
              }
            ]
          }
      },
      <span class="hljs-attr">"meta"</span>: {
        <span class="hljs-attr">"foo"</span>: <span class="hljs-string">"bar"</span>,
        <span class="hljs-attr">"baz"</span>: <span class="hljs-string">"boo"</span>
      },
      <span class="hljs-attr">"payload"</span>: {
        <span class="hljs-attr">"output"</span>: {
          <span class="hljs-attr">"anykey"</span>: <span class="hljs-string">"boo"</span>
        }
      }
    }
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="6-apply-remote-message-configuration"></a><a href="#6-apply-remote-message-configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6. Apply Remote Message Configuration</h4>
<p>If the <code>ReplaceConfig</code> configuration parameter is defined, the CMA will evaluate the configuration options provided, and if required write a portion of the Cumulus Message to S3, and add a <code>replace</code> key to the message for future steps to utilize.</p>
<p><strong><em>Please Note</em></strong>: the non user-modifiable field <code>cumulus-meta</code> will always be retained, regardless of the configuration.</p>
<p>For example, if the output message (post output configuration) from a cumulus message looks like:</p>
<pre><code class="hljs css language-json">    {
      <span class="hljs-attr">"cumulus_meta"</span>: {
        <span class="hljs-attr">"some_key"</span>: <span class="hljs-string">"some_value"</span>
      },
      <span class="hljs-attr">"ReplaceConfig"</span>: {
        <span class="hljs-attr">"FullMessage"</span>: <span class="hljs-literal">true</span>
      },
      <span class="hljs-attr">"task_config"</span>: {
        <span class="hljs-attr">"cumulus_message"</span>: {
          <span class="hljs-attr">"outputs"</span>: [
            {
              <span class="hljs-attr">"source"</span>: <span class="hljs-string">"{$}"</span>,
              <span class="hljs-attr">"destination"</span>: <span class="hljs-string">"{$.payload}"</span>
            },
            {
              <span class="hljs-attr">"source"</span>: <span class="hljs-string">"{$.output.anykey}"</span>,
              <span class="hljs-attr">"destination"</span>: <span class="hljs-string">"{$.meta.baz}"</span>
            }
          ]
        }
      },
      <span class="hljs-attr">"meta"</span>: {
        <span class="hljs-attr">"foo"</span>: <span class="hljs-string">"bar"</span>,
        <span class="hljs-attr">"baz"</span>: <span class="hljs-string">"boo"</span>
      },
      <span class="hljs-attr">"payload"</span>: {
        <span class="hljs-attr">"output"</span>: {
          <span class="hljs-attr">"anykey"</span>: <span class="hljs-string">"boo"</span>
        }
      }
    }
</code></pre>
<p>the resultant output would look like:</p>
<pre><code class="hljs css language-json">{
  <span class="hljs-attr">"cumulus_meta"</span>: {
    <span class="hljs-attr">"some_key"</span>: <span class="hljs-string">"some_value"</span>
  },
  <span class="hljs-attr">"replace"</span>: {
    <span class="hljs-attr">"TargetPath"</span>: <span class="hljs-string">"$"</span>,
    <span class="hljs-attr">"Bucket"</span>: <span class="hljs-string">"some-internal-bucket"</span>,
    <span class="hljs-attr">"Key"</span>: <span class="hljs-string">"events/some-event-id"</span>
  }
}
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="additional-features"></a><a href="#additional-features" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Additional Features:</h3>
<h4><a class="anchor" aria-hidden="true" id="validate-task-input-output-and-configuration-messages-against-the-schemas-provided"></a><a href="#validate-task-input-output-and-configuration-messages-against-the-schemas-provided" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Validate task input, output and configuration messages against the schemas provided.</h4>
<p>The Cumulus Message Adapter has the capability to validate task input, output and configuration messages against their schemas.  The default location of the schemas is the schemas folder in the top level of the task and the default filenames are input.json, output.json, and config.json. The task can also configure a different schema location.  If no schema can be found, the Cumulus Message Adapter will not validate the messages.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/cumulus/docs/1.15.0/workflows/protocol"><span class="arrow-prev">← </span><span>Workflow Protocol</span></a><a class="docs-next button" href="/cumulus/docs/1.15.0/workflows/cumulus-task-message-flow"><span>Cumulus Tasks: Message Flow</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#general-structure">General Structure</a></li><li><a href="#cumulus-message-adapter">Cumulus Message Adapter</a><ul class="toc-headings"><li><a href="#cma-inputoutput">CMA Input/Output</a></li><li><a href="#cma-configuration">CMA configuration</a></li><li><a href="#cumulus-message-adapter-has-the-following-steps">Cumulus Message Adapter has the following steps:</a></li><li><a href="#additional-features">Additional Features:</a></li></ul></li></ul></nav></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'f7e0be879553661f9043322d119069c8',
                indexName: 'nasa_cumulus',
                inputSelector: '#search_input_react'
              });
            </script></body></html>