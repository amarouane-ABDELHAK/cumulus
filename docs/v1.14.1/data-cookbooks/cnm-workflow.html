<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>CNM Workflow · Cumulus Documentation</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="# CNM Workflow"/><meta name="docsearch:version" content="v1.14.1"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="CNM Workflow · Cumulus Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://nasa.github.io/cumulus/"/><meta property="og:description" content="# CNM Workflow"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/cumulus/undefined"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/cumulus/js/scrollSpy.js"></script><link rel="stylesheet" href="/cumulus/css/main.css"/><script src="/cumulus/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/cumulus/"><h2 class="headerTitle">Cumulus Documentation</h2></a><a href="/cumulus/versions"><h3>v1.14.1</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://nasa.github.io/cumulus-api" target="_self">API Docs</a></li><li class=""><a href="/cumulus/docs/v1.14.1/cumulus-docs-readme" target="_self">Developer Docs</a></li><li class="siteNavGroupActive"><a href="/cumulus/docs/v1.14.1/data-cookbooks/about-cookbooks" target="_self">Data-Cookbooks</a></li><li class=""><a href="/cumulus/docs/v1.14.1/operator-docs/about-operator-docs" target="_self">Operator Docs</a></li><li class=""><a href="/cumulus/docs/v1.14.1/team" target="_self">Team</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Cookbooks</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">About Cookbooks<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v1.14.1/data-cookbooks/about-cookbooks">About Cookbooks</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v1.14.1/data-cookbooks/setup">Data Cookbooks Setup</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Cookbooks<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/cumulus/docs/v1.14.1/data-cookbooks/hello-world">HelloWorld Workflow</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v1.14.1/data-cookbooks/sns">SNS Notification in Workflows</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v1.14.1/data-cookbooks/sips-workflow">Science Investigator-led Processing Systems (SIPS)</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/cumulus/docs/v1.14.1/data-cookbooks/cnm-workflow">CNM Workflow</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v1.14.1/data-cookbooks/error-handling">Error Handling in Workflows</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v1.14.1/data-cookbooks/choice-states">Choice States</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v1.14.1/data-cookbooks/cloudwatch-retention">Cloudwatch Retention</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v1.14.1/data-cookbooks/browse-generation">Ingest Browse Generation</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v1.14.1/data-cookbooks/tracking-files">Tracking Ancillary Files</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v1.14.1/data-cookbooks/run-tasks-in-lambda-or-docker">Run Step Function Tasks in Lambda or Docker</a></li><li class="navListItem"><a class="navItem" href="/cumulus/docs/v1.14.1/data-cookbooks/throttling-queued-executions">Throttling queued executions</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="cnm-workflow"></a><a href="#cnm-workflow" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CNM Workflow</h1>
<p>This entry documents how to setup a workflow that utilizes the built-in CNM/Kinesis functionality in Cumulus.</p>
<p>Prior to working through this entry you should be familiar with the <a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cloud+Notification+Mechanism">Cloud Notification Mechanism</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="sections"></a><a href="#sections" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sections:</h2>
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#configure-the-workflow">Configure the Workflow</a></li>
<li><a href="#execute-the-workflow">Execute the Workflow</a></li>
<li><a href="#verify-results">Verify Results</a></li>
<li><a href="#kinesis-record-error-handling">Kinesis Record Error Handling</a></li>
</ul>
<hr>
<h2><a class="anchor" aria-hidden="true" id="prerequisites"></a><a href="#prerequisites" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Prerequisites</h2>
<h4><a class="anchor" aria-hidden="true" id="cumulus"></a><a href="#cumulus" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cumulus</h4>
<p>This entry assumes you have a deployed instance of Cumulus (&gt;= version 1.8).</p>
<h4><a class="anchor" aria-hidden="true" id="aws-cli"></a><a href="#aws-cli" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>AWS CLI</h4>
<p>This entry assumes you have the <a href="https://aws.amazon.com/cli/">AWS CLI</a> installed and configured. If you do not, please take a moment to review the documentation - particularly the <a href="https://docs.aws.amazon.com/streams/latest/dev/fundamental-stream.html">examples relevant to Kinesis</a> - and install it now.</p>
<h4><a class="anchor" aria-hidden="true" id="kinesis"></a><a href="#kinesis" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kinesis</h4>
<p>This entry assumes you already have two <a href="https://aws.amazon.com/kinesis/">Kinesis</a> data steams created for use as CNM notification and response data streams.</p>
<p>If you do not have two streams setup, please take a moment to review the <a href="https://aws.amazon.com/documentation/kinesis/">Kinesis documentation</a> and setup two basic single-shard streams for this example:</p>
<p>Using the &quot;Create Data Stream&quot; button on the <a href="https://console.aws.amazon.com/kinesis/home">Kinesis Dashboard</a>, work through the dialogue.</p>
<p>You should be able to quickly use the &quot;Create Data Stream&quot; button on the <a href="https://console.aws.amazon.com/kinesis/home">Kinesis Dashboard</a>, and setup streams that are similar to the following example:</p>
<p><img src="/cumulus/docs/assets/cnm_create_kinesis_stream.jpg" alt=""></p>
<p>Please bear in mind that your <code>{{prefix}}-lambda-processing</code> IAM role will need permissions to write to the response stream for this workflow to succeed if you create the Kinesis stream with a dashboard user.   If you are using the example deployment (or a deployment based on it), the IAM permissions should be set properly.</p>
<p>If not, the most straightforward approach is to attach the <code>AmazonKinesisFullAccess</code> policy for the stream resource to whatever role your lambdas are using, however your environment/security policies may require an approach specific to your deployment environment.</p>
<p>In operational environments it's likely science data providers would typically be responsible for providing a Kinesis stream with the appropriate permissions.</p>
<p>For more information on how this process works and how to develop a process that will add records to a stream, read the <a href="https://aws.amazon.com/documentation/kinesis/">Kinesis documentation</a> and the <a href="https://docs.aws.amazon.com/streams/latest/dev/introduction.html">developer guide</a>.</p>
<h4><a class="anchor" aria-hidden="true" id="source-data"></a><a href="#source-data" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Source Data</h4>
<p>This entry will run the SyncGranule task against a single target data file.  To that end it will require a single data file to be present in an S3 bucket matching the Provider configured in the next section.</p>
<h4><a class="anchor" aria-hidden="true" id="collection-and-provider"></a><a href="#collection-and-provider" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Collection and Provider</h4>
<p>Cumulus will need to be configured with a Collection and Provider entry of your choosing.  The provider should match the location of the source data from the <code>Ingest Source Data</code> section.</p>
<p>This can be done via the <a href="https://github.com/nasa/cumulus-dashboard">Cumulus Dashboard</a> if installed or the <a href="/cumulus/docs/v1.14.1/api">API</a>.  It is strongly recommended to use the dashboard if possible.</p>
<hr>
<h2><a class="anchor" aria-hidden="true" id="configure-the-workflow"></a><a href="#configure-the-workflow" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configure the Workflow</h2>
<p>Provided the prerequisites have been fulfilled, you can begin adding the needed values to your Cumulus configuration to configure the example workflow.</p>
<p>The following are steps that are required to set up your Cumulus instance to run the example workflow:</p>
<h4><a class="anchor" aria-hidden="true" id="example-cnm-workflow-configuration"></a><a href="#example-cnm-workflow-configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Example CNM Workflow Configuration</h4>
<p>In this example, we're going to trigger a workflow by creating a Kinesis rule and sending a record to a Kinesis stream.</p>
<p>The following <a href="/cumulus/docs/v1.14.1/workflows/workflows-readme">workflow definition</a> should be added to your deployment's <code>workflows.yml</code>.</p>
<p>Update the <code>CNMResponseStream</code> key in the <code>CnmResponse</code> task to match the name of the Kinesis response stream you configured in the prerequisites section.</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">CNMExampleWorkflow:</span>
  <span class="hljs-attr">Comment:</span> <span class="hljs-string">CNMExampleWorkflow</span>
  <span class="hljs-attr">StartAt:</span> <span class="hljs-string">StartStatus</span>
  <span class="hljs-attr">States:</span>
    <span class="hljs-attr">StartStatus:</span>
      <span class="hljs-attr">Type:</span> <span class="hljs-string">Task</span>
      <span class="hljs-attr">Resource:</span> <span class="hljs-string">${SfSnsReportLambdaFunction.Arn}</span>
      <span class="hljs-attr">CumulusConfig:</span>
        <span class="hljs-attr">cumulus_message:</span>
          <span class="hljs-attr">input:</span> <span class="hljs-string">'{$}'</span>
      <span class="hljs-attr">Next:</span> <span class="hljs-string">TranslateMessage</span>
      <span class="hljs-attr">Catch:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">ErrorEquals:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">States.ALL</span>
          <span class="hljs-attr">ResultPath:</span> <span class="hljs-string">'$.exception'</span>
          <span class="hljs-attr">Next:</span> <span class="hljs-string">CnmResponse</span>
    <span class="hljs-attr">TranslateMessage:</span>
      <span class="hljs-attr">Type:</span> <span class="hljs-string">Task</span>
      <span class="hljs-attr">Resource:</span> <span class="hljs-string">${CNMToCMALambdaFunction.Arn}</span>
      <span class="hljs-attr">CumulusConfig:</span>
        <span class="hljs-attr">cumulus_message:</span>
          <span class="hljs-attr">outputs:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">'{$.cnm}'</span>
              <span class="hljs-attr">destination:</span> <span class="hljs-string">'{$.meta.cnm}'</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">'{$}'</span>
              <span class="hljs-attr">destination:</span> <span class="hljs-string">'{$.payload}'</span>
      <span class="hljs-attr">Catch:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">ErrorEquals:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">States.ALL</span>
          <span class="hljs-attr">ResultPath:</span> <span class="hljs-string">'$.exception'</span>
          <span class="hljs-attr">Next:</span> <span class="hljs-string">CnmResponse</span>
      <span class="hljs-attr">Next:</span> <span class="hljs-string">SyncGranule</span>
    <span class="hljs-attr">SyncGranule:</span>
      <span class="hljs-attr">CumulusConfig:</span>
        <span class="hljs-attr">provider:</span> <span class="hljs-string">'{$.meta.provider}'</span>
        <span class="hljs-attr">buckets:</span> <span class="hljs-string">'{$.meta.buckets}'</span>
        <span class="hljs-attr">collection:</span> <span class="hljs-string">'{$.meta.collection}'</span>
        <span class="hljs-attr">downloadBucket:</span> <span class="hljs-string">'{$.meta.buckets.private.name}'</span>
        <span class="hljs-attr">stack:</span> <span class="hljs-string">'{$.meta.stack}'</span>
        <span class="hljs-attr">cumulus_message:</span>
          <span class="hljs-attr">outputs:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">'{$.granules}'</span>
              <span class="hljs-attr">destination:</span> <span class="hljs-string">'{$.meta.input_granules}'</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">'{$}'</span>
              <span class="hljs-attr">destination:</span> <span class="hljs-string">'{$.payload}'</span>
      <span class="hljs-attr">Type:</span> <span class="hljs-string">Task</span>
      <span class="hljs-attr">Resource:</span> <span class="hljs-string">${SyncGranuleLambdaFunction.Arn}</span>
      <span class="hljs-attr">Retry:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">ErrorEquals:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">States.ALL</span>
          <span class="hljs-attr">IntervalSeconds:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">MaxAttempts:</span> <span class="hljs-number">3</span>
      <span class="hljs-attr">Catch:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">ErrorEquals:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">States.ALL</span>
          <span class="hljs-attr">ResultPath:</span> <span class="hljs-string">'$.exception'</span>
          <span class="hljs-attr">Next:</span> <span class="hljs-string">CnmResponse</span>
      <span class="hljs-attr">Next:</span> <span class="hljs-string">CnmResponse</span>
    <span class="hljs-attr">CnmResponse:</span>
      <span class="hljs-attr">CumulusConfig:</span>
        <span class="hljs-attr">OriginalCNM:</span> <span class="hljs-string">'{$.meta.cnm}'</span>
        <span class="hljs-attr">CNMResponseStream:</span> <span class="hljs-string">'ADD YOUR RESPONSE STREAM HERE'</span>
        <span class="hljs-attr">region:</span> <span class="hljs-string">'us-east-1'</span>
        <span class="hljs-attr">WorkflowException:</span> <span class="hljs-string">'{$.exception}'</span>
        <span class="hljs-attr">cumulus_message:</span>
          <span class="hljs-attr">outputs:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">'{$}'</span>
              <span class="hljs-attr">destination:</span> <span class="hljs-string">'{$.meta.cnmResponse}'</span>
      <span class="hljs-attr">Type:</span> <span class="hljs-string">Task</span>
      <span class="hljs-attr">Resource:</span> <span class="hljs-string">${CnmResponseLambdaFunction.Arn}</span>
      <span class="hljs-attr">Retry:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">ErrorEquals:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">States.ALL</span>
          <span class="hljs-attr">IntervalSeconds:</span> <span class="hljs-number">5</span>
          <span class="hljs-attr">MaxAttempts:</span> <span class="hljs-number">3</span>
      <span class="hljs-attr">Catch:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">ErrorEquals:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">States.ALL</span>
          <span class="hljs-attr">ResultPath:</span> <span class="hljs-string">'$.exception'</span>
          <span class="hljs-attr">Next:</span> <span class="hljs-string">StopStatus</span>
      <span class="hljs-attr">Next:</span> <span class="hljs-string">StopStatus</span>
    <span class="hljs-attr">StopStatus:</span>
      <span class="hljs-attr">Type:</span> <span class="hljs-string">Task</span>
      <span class="hljs-attr">Resource:</span> <span class="hljs-string">${SfSnsReportLambdaFunction.Arn}</span>
      <span class="hljs-attr">CumulusConfig:</span>
        <span class="hljs-attr">sfnEnd:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">stack:</span> <span class="hljs-string">'{$.meta.stack}'</span>
        <span class="hljs-attr">bucket:</span> <span class="hljs-string">'{$.meta.buckets.internal.name}'</span>
        <span class="hljs-attr">stateMachine:</span> <span class="hljs-string">'{$.cumulus_meta.state_machine}'</span>
        <span class="hljs-attr">executionName:</span> <span class="hljs-string">'{$.cumulus_meta.execution_name}'</span>
        <span class="hljs-attr">cumulus_message:</span>
          <span class="hljs-attr">input:</span> <span class="hljs-string">'{$}'</span>
      <span class="hljs-attr">Catch:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">ErrorEquals:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">States.ALL</span>
          <span class="hljs-attr">Next:</span> <span class="hljs-string">WorkflowFailed</span>
      <span class="hljs-attr">End:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">WorkflowFailed:</span>
      <span class="hljs-attr">Type:</span> <span class="hljs-string">Fail</span>
      <span class="hljs-attr">Cause:</span> <span class="hljs-string">'Workflow failed'</span>

</code></pre>
<p>Again, please make sure to modify the value CNMResponseStream to match the stream name (not ARN) for your Kinesis response stream.</p>
<h4><a class="anchor" aria-hidden="true" id="task-configuration"></a><a href="#task-configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Task Configuration</h4>
<p>The following tasks are required to be defined in the <code>lambdas.yml</code> configuration file.</p>
<p>If you're using a deployment based on the <a href="https://github.com/nasa/cumulus/tree/master/example">example deployment</a> these lambdas should already be defined for you.</p>
<h6><a class="anchor" aria-hidden="true" id="cnmtocma"></a><a href="#cnmtocma" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CNMToCMA</h6>
<p>The example workflow assumes you have a CNM to Cumulus Message Adapter (CMA) translation lambda defined as <code>CNMToCMA</code> in the <code>lambdas.yml</code> file:</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">CNMToCMA:</span>
  <span class="hljs-attr">handler:</span> <span class="hljs-string">'gov.nasa.cumulus.CnmToGranuleHandler::handleRequestStreams'</span>
  <span class="hljs-attr">timeout:</span> <span class="hljs-number">300</span>
  <span class="hljs-attr">runtime:</span> <span class="hljs-string">java8</span>
  <span class="hljs-attr">memory:</span> <span class="hljs-number">128</span>
  <span class="hljs-attr">s3Source:</span>
    <span class="hljs-attr">bucket:</span> <span class="hljs-string">'cumulus-data-shared'</span>
    <span class="hljs-attr">key:</span> <span class="hljs-string">'daacs/podaac/cnmToGranule-1.0-wCMA.zip'</span>
  <span class="hljs-attr">useMessageAdapter:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">launchInVpc:</span> <span class="hljs-literal">true</span>
</code></pre>
<p><code>CNMToCMA</code> is meant for the beginning of a workflow: it maps CNM granule information to a payload for downstream tasks. This workflow will not utilize the payload. For other workflows, you would need to ensure that downstream tasks in your workflow either understand the CNM message <em>or</em> include a translation task like this one.</p>
<p>You can also manipulate the data sent to downstream tasks using <code>CumulusConfig</code> for various states in <code>workflows.yml</code>. Read more about how to configure data on the <a href="https://nasa.github.io/cumulus/docs/workflows/input_output">Workflow Input &amp; Output</a> page.</p>
<h6><a class="anchor" aria-hidden="true" id="cnmresponse"></a><a href="#cnmresponse" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CnmResponse</h6>
<p>The workflow defined above assumes a CNM response task defined in the <code>lambdas.yml</code> configuration file. Example:</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">CnmResponse:</span>
  <span class="hljs-attr">handler:</span> <span class="hljs-string">'gov.nasa.cumulus.CNMResponse::handleRequestStreams'</span>
  <span class="hljs-attr">timeout:</span> <span class="hljs-number">300</span>
  <span class="hljs-attr">useMessageAdapter:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">runtime:</span> <span class="hljs-string">java8</span>
  <span class="hljs-attr">memory:</span> <span class="hljs-number">256</span>
  <span class="hljs-attr">s3Source:</span>
    <span class="hljs-attr">bucket:</span> <span class="hljs-string">'cumulus-data-shared'</span>
    <span class="hljs-attr">key:</span> <span class="hljs-string">'daacs/podaac/cnmResponse-1.0.zip'</span>
  <span class="hljs-attr">launchInVpc:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>The <code>CnmResponse</code> lambda generates a CNM response message and puts it on a the <code>CNMResponseStream</code> Kinesis stream.</p>
<p>The <code>CnmResponse</code> lambda package is provided (as of release 1.8) in the <code>cumulus-data-shared</code> bucket, with documentation provided in the <a href="https://git.earthdata.nasa.gov/projects/POCUMULUS/repos/cnmresponsetask/browse">source repository</a>.</p>
<p>You can read more about the expected schema a <code>CnmResponse</code> record on the wiki page for <a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cloud+Notification+Mechanism#CloudNotificationMechanism-ResponseMessageFields">Cloud Notification Mechanism</a>.</p>
<h6><a class="anchor" aria-hidden="true" id="additional-tasks"></a><a href="#additional-tasks" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Additional Tasks</h6>
<p>Lastly, this entry also includes the tasks  <code>SfSnsReport</code>, <code>SyncGranule</code> from the <a href="https://github.com/nasa/cumulus/tree/master/example">example deployment</a> are defined in the <code>lambdas.yml</code>.</p>
<h3><a class="anchor" aria-hidden="true" id="redeploy"></a><a href="#redeploy" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Redeploy</h3>
<p>Once the above configuration changes have been made, redeploy your stack.</p>
<p>Please refer to <code>Updating Cumulus deployment</code> in the <a href="/cumulus/docs/v1.14.1/deployment/deployment-readme">deployment documentation</a> if you are unfamiliar with redeployment.</p>
<h3><a class="anchor" aria-hidden="true" id="rule-configuration"></a><a href="#rule-configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Rule Configuration</h3>
<p><code>@cumulus/api</code> includes a <code>messageConsumer</code> lambda function (<a href="https://github.com/nasa/cumulus/blob/master/packages/api/lambdas/message-consumer.js">message-consumer</a>). Cumulus kinesis-type rules create the <a href="https://docs.aws.amazon.com/lambda/latest/dg/API_CreateEventSourceMapping.html">event source mappings</a> between Kinesis streams and the <code>messageConsumer</code> lambda. The <code>messageConsumer</code> lambda consumes records from one or more Kinesis streams, as defined by enabled kinesis-type rules. When new records are pushed to one of these streams, the <code>messageConsumer</code> triggers workflows associated with the enabled kinesis-type rules.</p>
<p>To add a rule via the dashboard (if you'd like to use the API, see the docs <a href="https://nasa.github.io/cumulus-api/#create-rule">here</a>), navigate to the <code>Rules</code> page and click <code>Add a rule</code>, then configure the new rule using the following template (substituting correct values for parameters denoted by <code>${}</code>:</p>
<pre><code class="hljs css language-json">{
  <span class="hljs-attr">"collection"</span>: {
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"L2_HR_PIXC"</span>,
    <span class="hljs-attr">"version"</span>: <span class="hljs-string">"000"</span>
  },
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"L2_HR_PIXC_kinesisRule"</span>,
  <span class="hljs-attr">"provider"</span>: <span class="hljs-string">"PODAAC_SWOT"</span>,
  <span class="hljs-attr">"rule"</span>: {
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"kinesis"</span>,
    <span class="hljs-attr">"value"</span>: <span class="hljs-string">"arn:aws:kinesis:{{awsRegion}}:{{awsAccountId}}:stream/{{streamName}}"</span>
  },
  <span class="hljs-attr">"state"</span>: <span class="hljs-string">"ENABLED"</span>,
  <span class="hljs-attr">"workflow"</span>: <span class="hljs-string">"CNMExampleWorkflow"</span>
}
</code></pre>
<p><strong>Please Note:</strong></p>
<ul>
<li>The rule's <code>value</code> attribute value must match the Amazon Resource Name <a href="https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html">ARN</a> for the Kinesis data stream you've preconfigured.   You should be able to obtain this ARN from the Kinesis Dashboard entry for the selected stream.</li>
<li>The collection and provider should match the collection and provider you setup in the <a href="#prerequisites"><code>Prerequisites</code></a> section.</li>
</ul>
<p>Once you've clicked on 'submit' a new rule should appear in the dashboard's Rule Overview.</p>
<hr>
<h2><a class="anchor" aria-hidden="true" id="execute-the-workflow"></a><a href="#execute-the-workflow" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Execute the Workflow</h2>
<p>Once Cumulus has been redeployed and a rule has been added, we're ready to trigger the workflow and watch it execute.</p>
<h3><a class="anchor" aria-hidden="true" id="how-to-trigger-the-workflow"></a><a href="#how-to-trigger-the-workflow" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to Trigger the Workflow</h3>
<p>To trigger matching workflows, you will need to put a record on the Kinesis stream the <a href="https://github.com/nasa/cumulus/blob/master/packages/api/lambdas/message-consumer.js">message-consumer</a> lambda will recognize as a matching event. Most importantly, it should include a <code>collection</code> key / value pair that matches a valid collection.</p>
<p>For the purpose of this example, the easiest way to accomplish this is using the <a href="https://aws.amazon.com/cli/">AWS CLI</a>.</p>
<h4><a class="anchor" aria-hidden="true" id="create-record-json"></a><a href="#create-record-json" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create Record JSON</h4>
<p>Construct a JSON file containing an object that matches the values that have been previously setup. This JSON object should be a valid <a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cloud+Notification+Mechanism">Cloud Notification Mechanism</a> message.</p>
<p><strong>Please note</strong>: <em>this example is somewhat contrived, as the downstream tasks don't care about most of these fields. A 'real' data ingest workflow would.</em></p>
<p>The following values (denoted by ${} in the sample below) should be replaced to match values we've previously configured:</p>
<ul>
<li><code>TEST_DATA_FILE_NAME</code>:  The filename of the test data that is available in the S3 (or other) provider we created earlier.</li>
<li><code>TEST_DATA_URI</code>: The full S3 path to the test data (e.g. <a href="s3://bucket-name/path/granule">s3://bucket-name/path/granule</a>)</li>
<li><code>COLLECTION</code>:  The collection defined in the prerequisites for this product</li>
</ul>
<pre><code class="hljs css language-json">{
  <span class="hljs-attr">"product"</span>: {
    <span class="hljs-attr">"files"</span>: [
      {
        <span class="hljs-attr">"checksum-type"</span>: <span class="hljs-string">"md5"</span>,
        <span class="hljs-attr">"name"</span>: <span class="hljs-string">"${TEST_DATA_FILE_NAME}"</span>,
        <span class="hljs-attr">"checksum"</span>: <span class="hljs-string">"bogus_checksum_value"</span>,
        <span class="hljs-attr">"uri"</span>: <span class="hljs-string">"${TEST_DATA_URI}"</span>,
        <span class="hljs-attr">"type"</span>: <span class="hljs-string">"data"</span>,
        <span class="hljs-attr">"size"</span>: <span class="hljs-number">12345678</span>
      }
    ],
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"${TEST_DATA_FILE_NAME}"</span>,
    <span class="hljs-attr">"dataVersion"</span>: <span class="hljs-string">"006"</span>
  },
  <span class="hljs-attr">"identifier "</span>: <span class="hljs-string">"testIdentifier123456"</span>,
  <span class="hljs-attr">"collection"</span>: <span class="hljs-string">"${COLLECTION}"</span>,
  <span class="hljs-attr">"provider"</span>: <span class="hljs-string">"TestProvider"</span>,
  <span class="hljs-attr">"version"</span>: <span class="hljs-string">"001"</span>
}
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="add-record-to-kinesis-data-stream"></a><a href="#add-record-to-kinesis-data-stream" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Add Record to Kinesis Data Stream</h4>
<p>Using the JSON file you created, push it to the Kinesis notification stream:</p>
<pre><code class="hljs css language-bash">aws kinesis put-record --stream-name YOUR_KINESIS_NOTIFICATION_STREAM_NAME_HERE --partition-key 1 --data file:///path/to/file.json
</code></pre>
<p><strong>Please note</strong>: The above command uses the stream name, <em>not</em> the ARN.</p>
<p>The command should return output similar to:</p>
<pre><code class="hljs css language-json">{
    <span class="hljs-attr">"ShardId"</span>: <span class="hljs-string">"shardId-000000000000"</span>,
    <span class="hljs-attr">"SequenceNumber"</span>: <span class="hljs-string">"42356659532578640215890215117033555573986830588739321858"</span>
}
</code></pre>
<p>This command will put a record containing the JSON from the <code>--data</code> flag onto the Kinesis data stream. The <code>messageConsumer</code> lambda will consume the record and construct a valid CMA payload to trigger workflows. For this example, the record will trigger the <code>CNMExampleWorkflow</code> workflow as defined by the rule previously configured.</p>
<p>You can view the current running executions on the <code>Executions</code> dashboard page which presents a list of all executions, their status (running, failed, or completed), to which workflow the execution belongs, along with other information.</p>
<h3><a class="anchor" aria-hidden="true" id="verify-workflow-execution"></a><a href="#verify-workflow-execution" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Verify Workflow Execution</h3>
<p>As detailed above, once the record is added to the Kinesis data stream, the <code>messageConsumer</code> lambda will trigger the <code>CNMExampleWorkflow</code> .</p>
<h4><a class="anchor" aria-hidden="true" id="startstatus"></a><a href="#startstatus" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>StartStatus</h4>
<p>The first task in the execution will report to Cumulus that the workflow has started execution and pass the CNM message to the next step in the workflow</p>
<h4><a class="anchor" aria-hidden="true" id="translatemessage"></a><a href="#translatemessage" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>TranslateMessage</h4>
<p><code>TranslateMessage</code> (which corresponds to the <code>CNMToCMA</code> lambda) will take the CNM object payload and add a granules object to the CMA payload that's consistent with other Cumulus ingest tasks, and add a key 'cnm' to 'meta' (as well as the payload) to store the original message.</p>
<p><em>For more on the Message Adapter, please see <a href="/cumulus/docs/v1.14.1/workflows/cumulus-task-message-flow">the Message Flow documentation</a></em>.</p>
<p>An example of what is happening in the <code>CNMToCMA</code> lambda is as follows:</p>
<p>Example Input Payload:</p>
<pre><code class="hljs css language-json">"payload": {
  "identifier ": "testIdentifier123456",
  "product": {
    "files": [
      {
        "checksum-type": "md5",
        "name": "MOD09GQ.A2016358.h13v04.006.2016360104606.hdf",
        "checksum": "bogus_checksum_value",
        "uri": "s3://some_bucket/cumulus-test-data/pdrs/MOD09GQ.A2016358.h13v04.006.2016360104606.hdf",
        "type": "data",
        "size": 12345678
      }
    ],
    "name": "TestGranuleUR",
    "dataVersion": "006"
  },
  "version": "123456",
  "collection": "MOD09GQ",
  "provider": "TestProvider"
}
</code></pre>
<p>Example Output Payload:</p>
<pre><code class="hljs css language-json">  "payload": {
    "cnm": {
      "identifier ": "testIdentifier123456",
      "product": {
        "files": [
          {
            "checksum-type": "md5",
            "name": "MOD09GQ.A2016358.h13v04.006.2016360104606.hdf",
            "checksum": "bogus_checksum_value",
            "uri": "s3://some-bucket/cumulus-test-data/data/MOD09GQ.A2016358.h13v04.006.2016360104606.hdf",
            "type": "data",
            "size": 12345678
          }
        ],
        "name": "TestGranuleUR",
        "dataVersion": "006"
      },
      "version": "123456",
      "collection": "MOD09GQ",
      "provider": "TestProvider"
    },
    "granules": [
      {
        "granuleId": "TestGranuleUR",
        "files": [
          {
            "path": "some-bucket/data",
            "url_path": "s3://some-bucket/cumulus-test-data/data/MOD09GQ.A2016358.h13v04.006.2016360104606.hdf",
            "bucket": "some-bucket",
            "name": "MOD09GQ.A2016358.h13v04.006.2016360104606.hdf",
            "size": 12345678
          }
        ]
      }
    ]
  }
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="syncgranules"></a><a href="#syncgranules" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SyncGranules</h4>
<p>This lambda will take the files listed in the payload and move them to <code>s3://{deployment-private-bucket}/file-staging/{deployment-name}/{COLLECTION}/{file_name}</code>.</p>
<h4><a class="anchor" aria-hidden="true" id="cnmresponse-1"></a><a href="#cnmresponse-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CnmResponse</h4>
<p>Assuming a successful execution of the workflow, this task will recover the 'cnm' key from the 'meta' portion of the CMA output, and add a &quot;SUCCESS&quot; record to the notification Kinesis stream.</p>
<p>If a prior step in the the workflow has failed, this will add a &quot;FAILURE&quot; record to the stream instead.</p>
<p>The data written to the <code>CnmResponseStream</code> should adhere to the <a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cloud+Notification+Mechanism#CloudNotificationMechanism-ResponseMessageFields">Response Message Fields</a> schema.</p>
<p><strong>Example CNM Success Response</strong></p>
<pre><code class="hljs css language-json">{
  <span class="hljs-attr">"provider"</span>: <span class="hljs-string">"PODAAC_SWOT"</span>,
  <span class="hljs-attr">"collection"</span>: <span class="hljs-string">"SWOT_Prod_l2:1"</span>,
  <span class="hljs-attr">"ingestTime"</span>:<span class="hljs-string">"2017-09-30T03:45:29.791198"</span>,
  <span class="hljs-attr">"receivedTime"</span>:<span class="hljs-string">"2017-09-30T03:42:31.634552"</span>,
  <span class="hljs-attr">"deliveryTime"</span>:<span class="hljs-string">"2017-09-30T03:42:29.791198"</span>,
  <span class="hljs-attr">"identifier"</span>: <span class="hljs-string">"1234-abcd-efg0-9876"</span>,
  <span class="hljs-attr">"response"</span>: {
    <span class="hljs-attr">"status"</span>:<span class="hljs-string">"SUCCESS"</span>
  }
}
</code></pre>
<p><strong>Example CNM Error Response</strong></p>
<pre><code class="hljs css language-json">{
  <span class="hljs-attr">"provider"</span>: <span class="hljs-string">"PODAAC_SWOT"</span>,
  <span class="hljs-attr">"collection"</span>: <span class="hljs-string">"SWOT_Prod_l2:1"</span>,
  <span class="hljs-attr">"ingestTime"</span>:<span class="hljs-string">"2017-09-30T03:45:29.791198"</span>,
  <span class="hljs-attr">"deliveryTime"</span>:<span class="hljs-string">"2017-09-30T03:42:29.791198"</span>,
  <span class="hljs-attr">"receivedTime"</span>:<span class="hljs-string">"2017-09-30T03:42:31.634552"</span>,
  <span class="hljs-attr">"identifier"</span>: <span class="hljs-string">"1234-abcd-efg0-9876"</span>,
  <span class="hljs-attr">"response"</span>: {
    <span class="hljs-attr">"status"</span>:<span class="hljs-string">"FAILURE"</span>,
    <span class="hljs-attr">"errorCode"</span>: <span class="hljs-string">"INGEST_ERROR"</span>,
    <span class="hljs-attr">"errorMessage"</span>: <span class="hljs-string">"File [cumulus-dev-a4d38f59-5e57-590c-a2be-58640db02d91/prod_20170926T11:30:36/production_file.nc] did not match gve checksum value."</span>
  }
}
</code></pre>
<p>Note the <code>CnmResponse</code> state defined in the <code>workflows.yml</code> above configures <code>$.exception</code> to be passed to the <code>CnmResponse</code> lambda keyed under <code>config.WorkflowException</code>. This is required for the <code>CnmResponse</code> code to deliver a failure response.</p>
<p>To test the failure scenario, send a record missing the <code>collection</code> key.</p>
<h4><a class="anchor" aria-hidden="true" id="stopstatus"></a><a href="#stopstatus" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>StopStatus</h4>
<p>In case of either success <em>or</em> failure, <code>CnmResponse</code> will then pass the results to <code>StopStatus</code>. <code>StopStatus</code> will cause the workflow to fail or succeed accordingly.</p>
<hr>
<h2><a class="anchor" aria-hidden="true" id="verify-results"></a><a href="#verify-results" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Verify results</h2>
<h3><a class="anchor" aria-hidden="true" id="check-for-successful-execution-on-the-dashboard"></a><a href="#check-for-successful-execution-on-the-dashboard" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Check for successful execution on the dashboard</h3>
<p>Following the successful execution of this workflow, you should expect to see the workflow complete successfully on the dashboard:</p>
<p><img src="/cumulus/docs/assets/cnm_success_example.png" alt=""></p>
<h3><a class="anchor" aria-hidden="true" id="check-the-test-granule-has-been-delivered-to-s3-staging"></a><a href="#check-the-test-granule-has-been-delivered-to-s3-staging" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Check the test granule has been delivered to S3 staging</h3>
<p>The test granule identified in the Kinesis record should be moved to the deployment's private staging area.</p>
<h3><a class="anchor" aria-hidden="true" id="check-for-kinesis-records"></a><a href="#check-for-kinesis-records" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Check for Kinesis records</h3>
<p>A <code>SUCCESS</code> notification should be present on the <code>CNMResponseStream</code> Kinesis stream.</p>
<p>You should be able to validate the notification and response streams have the expected records with the following steps (the AWS CLI Kinesis <a href="https://docs.aws.amazon.com/streams/latest/dev/fundamental-stream.html">Basic Stream Operations</a> is useful to review before proceeding):</p>
<ul>
<li>Get a shard iterator (substituting your stream name as appropriate):</li>
</ul>
<pre><code class="hljs css language-bash">aws kinesis get-shard-iterator \
  --shard-id shardId-000000000000 \
  --shard-iterator-type LATEST \
  --stream-name NOTIFICATION_OR_RESPONSE_STREAM_NAME
</code></pre>
<p>which should result in an output to:</p>
<pre><code class="hljs css language-json">{
  <span class="hljs-attr">"ShardIterator"</span>: <span class="hljs-string">"VeryLongString=="</span>
}
</code></pre>
<ul>
<li>Re-trigger the workflow by using the <code>put-record</code> command from</li>
<li>As the workflow completes, use the output from the <code>get-shard-iterator</code> command to request data from the stream:</li>
</ul>
<pre><code class="hljs css language-bash">aws kinesis get-records --shard-iterator SHARD_ITERATOR_VALUE
</code></pre>
<p>This should result in output similar to:</p>
<pre><code class="hljs css language-json">{
    <span class="hljs-attr">"Records"</span>: [
        {
            <span class="hljs-attr">"SequenceNumber"</span>: <span class="hljs-string">"49586720336541656798369548102057798835250389930873978882"</span>,
            <span class="hljs-attr">"ApproximateArrivalTimestamp"</span>: <span class="hljs-number">1532664689.128</span>,
            <span class="hljs-attr">"Data"</span>: <span class="hljs-string">"eyJpZGVudGlmaWVyICI6InRlc3RJZGVudGlmaWVyMTIzNDU2IiwidmVyc2lvbiI6IjAwNiIsImNvbGxlY3Rpb24iOiJNT0QwOUdRIiwicHJvdmlkZXIiOiJUZXN0UHJvdmlkZXIiLCJwcm9kdWN0U2l6ZSI6MTkwODYzNS4wLCJyZXNwb25zZSI6eyJzdGF0dXMiOiJTVUNDRVNTIn0sInByb2Nlc3NDb21wbGV0ZVRpbWUiOiIyMDE4LTA3LTI3VDA0OjExOjI4LjkxOSJ9"</span>,
            <span class="hljs-attr">"PartitionKey"</span>: <span class="hljs-string">"1"</span>
        },
        {
            <span class="hljs-attr">"SequenceNumber"</span>: <span class="hljs-string">"49586720336541656798369548102059007761070005796999266306"</span>,
            <span class="hljs-attr">"ApproximateArrivalTimestamp"</span>: <span class="hljs-number">1532664707.149</span>,
            <span class="hljs-attr">"Data"</span>: <span class="hljs-string">"eyJpZGVudGlmaWVyICI6InRlc3RJZGVudGlmaWVyMTIzNDU2IiwidmVyc2lvbiI6IjAwNiIsImNvbGxlY3Rpb24iOiJNT0QwOUdRIiwicHJvdmlkZXIiOiJUZXN0UHJvdmlkZXIiLCJwcm9kdWN0U2l6ZSI6MTkwODYzNS4wLCJyZXNwb25zZSI6eyJzdGF0dXMiOiJTVUNDRVNTIn0sInByb2Nlc3NDb21wbGV0ZVRpbWUiOiIyMDE4LTA3LTI3VDA0OjExOjQ2Ljk1OCJ9"</span>,
            <span class="hljs-attr">"PartitionKey"</span>: <span class="hljs-string">"1"</span>
        }
    ],
    <span class="hljs-attr">"NextShardIterator"</span>: <span class="hljs-string">"AAAAAAAAAAFo9SkF8RzVYIEmIsTN+1PYuyRRdlj4Gmy3dBzsLEBxLo4OU+2Xj1AFYr8DVBodtAiXbs3KD7tGkOFsilD9R5tA+5w9SkGJZ+DRRXWWCywh+yDPVE0KtzeI0andAXDh9yTvs7fLfHH6R4MN9Gutb82k3lD8ugFUCeBVo0xwJULVqFZEFh3KXWruo6KOG79cz2EF7vFApx+skanQPveIMz/80V72KQvb6XNmg6WBhdjqAA=="</span>,
    <span class="hljs-attr">"MillisBehindLatest"</span>: <span class="hljs-number">0</span>
}
</code></pre>
<p>Note the data encoding is not human readable and would need to be parsed/converted to be interpretable. There are many options to build a Kineis consumer such as the <a href="https://docs.aws.amazon.com/streams/latest/dev/developing-consumers-with-kcl.html">KCL</a>.</p>
<p>For purposes of validating the workflow, it may be simpler to locate the workflow in the <a href="https://console.aws.amazon.com/states/home">Step Function Management Console</a> and assert the expected output is similar to the below examples.</p>
<p><strong>Successful CNM Response Object Example:</strong></p>
<pre><code class="hljs css language-json">{
  <span class="hljs-attr">"cnmResponse"</span>: {
    <span class="hljs-attr">"productSize"</span>: <span class="hljs-number">12345678</span>,
    <span class="hljs-attr">"processCompleteTime"</span>: <span class="hljs-string">"2018-07-27T05:43:41.698"</span>,
    <span class="hljs-attr">"collection"</span>: <span class="hljs-string">"MOD09GQ"</span>,
    <span class="hljs-attr">"version"</span>: <span class="hljs-string">"123456"</span>,
    <span class="hljs-attr">"provider"</span>: <span class="hljs-string">"TestProvider"</span>,
    <span class="hljs-attr">"identifier "</span>: <span class="hljs-string">"testIdentifier123456"</span>,
    <span class="hljs-attr">"response"</span>: {
      <span class="hljs-attr">"status"</span>: <span class="hljs-string">"SUCCESS"</span>
  }
}
</code></pre>
<hr>
<h2><a class="anchor" aria-hidden="true" id="kinesis-record-error-handling"></a><a href="#kinesis-record-error-handling" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kinesis Record Error Handling</h2>
<h3><a class="anchor" aria-hidden="true" id="messageconsumer"></a><a href="#messageconsumer" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>messageConsumer</h3>
<p>The default Kinesis stream processing in the Cumulus system is configured for record error tolerance.</p>
<p>When the <code>messageConsumer</code> fails to process a record, the failure is captured and the record is published to the <code>kinesisFallback</code> SNS Topic. The <code>kinesisFallback</code> SNS topic broadcasts the record and a subscribed copy of the <code>messageConsumer</code> lambda named <code>kinesisFallback</code> consumes these failures.</p>
<p>At this point, the <a href="https://docs.aws.amazon.com/lambda/latest/dg/retries-on-errors.html">normal lambda asynchronous invocation retry behavior</a> will attempt to process the record 3 mores times. After this, if the record cannot successfully be processed, it is written to a <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-dead-letter-queues.html">dead letter queue</a>. Cumulus' dead letter queue is an SQS Queue named <code>kinesisFailure</code>. Operators can use this queue to inspect failed records.</p>
<p>This system ensures when <code>messageConsumer</code> fails to process a record and trigger a workflow, the record is retried 3 times. This retry behavior improves system reliability in case of any external service failure outside of Cumulus control.</p>
<p>The Kinesis error handling system - the <code>kinesisFallback</code> SNS topic, <code>messageConsumer</code> lambda, and <code>kinesisFailure</code> SQS queue - come with the API package and do not need to be configured by the operator.</p>
<p>To examine records that were unable to be processed at any step you need to go look at the dead letter queue <code>{{prefix}}-kinesisFailure</code>.
Check the <a href="https://console.aws.amazon.com/sqs/home">Simple Queue Service (SQS) console</a>. Select your queue, and under the <code>Queue Actions</code> tab, you can choose <code>View/Delete Messages</code>. <code>Start polling</code> for messages and you will see records that failed to process through the <code>messageConsumer</code>.</p>
<p>Note, these are only records that occurred when processing records from Kinesis streams. Workflow failures are handled differently.</p>
<h3><a class="anchor" aria-hidden="true" id="kinesis-stream-logging"></a><a href="#kinesis-stream-logging" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kinesis Stream logging</h3>
<h4><a class="anchor" aria-hidden="true" id="notification-stream-messages"></a><a href="#notification-stream-messages" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Notification Stream messages</h4>
<p>Cumulus includes two lambdas (<code>KinesisInboundEventLogger</code> and <code>KinesisOutboundEventLogger</code>) that utilize the same code to take a Kinesis record event as input, deserialize the data field and output the modified event to the logs.</p>
<p>When a <code>kinesis</code> rule is created, in addition to the <code>messageConsumer</code> event mapping, an event mapping is created to trigger <code>KinesisInboundEventLogger</code> to record a log of the inbound record, to allow for analysis in case of unexpected failure.</p>
<h4><a class="anchor" aria-hidden="true" id="response-stream-messages"></a><a href="#response-stream-messages" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Response Stream messages</h4>
<p>Cumulus also supports this feature for all outbound  messages.  To take advantage of this feature, you will need to set an event mapping on the <code>KinesisOutboundEventLogger</code> lambda that targets your <code>cnmResponseStream</code>.   You can do this in the Lambda management page for <code>KinesisOutboundEventLogger</code>.    Add a Kinesis trigger, and configure it to target the cnmResponseStream for your workflow:</p>
<p><img src="/cumulus/docs/assets/KinesisLambdaTriggerConfiguration.png" alt=""></p>
<p>Once this is done, all records sent to the cnmResponseStream will also be logged in CloudWatch.    For more on configuring lambdas to trigger on Kinesis events, please see <a href="https://docs.aws.amazon.com/lambda/latest/dg/with-kinesis.html#services-kinesis-eventsourcemapping">creating an event source mapping</a>.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/cumulus/docs/v1.14.1/data-cookbooks/sips-workflow"><span class="arrow-prev">← </span><span>Science Investigator-led Processing Systems (SIPS)</span></a><a class="docs-next button" href="/cumulus/docs/v1.14.1/data-cookbooks/error-handling"><span>Error Handling in Workflows</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#sections">Sections:</a></li><li><a href="#prerequisites">Prerequisites</a></li><li><a href="#configure-the-workflow">Configure the Workflow</a><ul class="toc-headings"><li><a href="#redeploy">Redeploy</a></li><li><a href="#rule-configuration">Rule Configuration</a></li></ul></li><li><a href="#execute-the-workflow">Execute the Workflow</a><ul class="toc-headings"><li><a href="#how-to-trigger-the-workflow">How to Trigger the Workflow</a></li><li><a href="#verify-workflow-execution">Verify Workflow Execution</a></li></ul></li><li><a href="#verify-results">Verify results</a><ul class="toc-headings"><li><a href="#check-for-successful-execution-on-the-dashboard">Check for successful execution on the dashboard</a></li><li><a href="#check-the-test-granule-has-been-delivered-to-s3-staging">Check the test granule has been delivered to S3 staging</a></li><li><a href="#check-for-kinesis-records">Check for Kinesis records</a></li></ul></li><li><a href="#kinesis-record-error-handling">Kinesis Record Error Handling</a><ul class="toc-headings"><li><a href="#messageconsumer">messageConsumer</a></li><li><a href="#kinesis-stream-logging">Kinesis Stream logging</a></li></ul></li></ul></nav></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'f7e0be879553661f9043322d119069c8',
                indexName: 'nasa_cumulus',
                inputSelector: '#search_input_react'
              });
            </script></body></html>